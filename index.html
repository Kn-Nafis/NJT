<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>For My Valentine ‚ù§Ô∏è</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
</head>

<body>
  <!-- =========================
      1) PASSWORD LOCK OVERLAY
  ========================== -->
  <div class="lockOverlay" id="lockOverlay" aria-hidden="false">
    <div class="lockCard" role="dialog" aria-modal="true" aria-label="Unlock screen">
      <div class="lockBadge">üîí Private</div>
      <h2 class="lockTitle">Only for my favorite person ‚ù§Ô∏è</h2>
      <p class="lockSub">Enter our secret code to open</p>

      <form class="lockForm" id="lockForm">
        <input class="lockInput" id="lockInput" type="password" placeholder="Enter secret..." autocomplete="off" />
        <button class="btn primary" type="submit">Unlock ‚ú®</button>
      </form>

      <p class="lockHint" id="lockHint" aria-live="polite"></p>
      <p class="lockSmall">Tip: secret is inside the JS.</p>
    </div>
  </div>

  <!-- Floating hearts background -->
  <div class="hearts" aria-hidden="true">
    <span>‚ù§</span><span>‚ù§</span><span>‚ù§</span><span>‚ù§</span><span>‚ù§</span>
    <span>‚ù§</span><span>‚ù§</span><span>‚ù§</span><span>‚ù§</span><span>‚ù§</span>
  </div>

  <!-- Confetti canvas -->
  <canvas id="confettiCanvas" class="confettiCanvas" aria-hidden="true"></canvas>

  <!-- Cursor hearts layer -->
  <div class="cursorHearts" id="cursorHearts" aria-hidden="true"></div>

  <!-- Floating "Love note" button -->
  <button class="floatLove" id="floatLove" type="button" aria-label="Show a love note">üíå</button>

  <!-- Love note toast -->
  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Top nav -->
  <header class="topbar">
    <div class="brand">My Beloved</div>

    <nav class="nav" aria-label="Primary">
      <a href="#story">Our Story</a>
      <a href="#reasons">Reasons</a>
      <a href="#openwhen">Open When</a>
      <a href="#distance">Distance</a>
      <a href="#mood">Mood</a>
      <a href="#slideshow">Slideshow</a>
      <a href="#gallery">Gallery</a>
      <a href="#letter">Letter</a>
      <a href="#diary">Diary</a>
    </nav>

    <div class="topActions">
      <button class="toggleBtn" id="themeBtn" type="button" aria-label="Toggle theme">üåô</button>
      <button class="musicBtn" id="musicBtn" type="button" aria-label="Toggle music">‚ô´</button>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="heroOverlay"></div>
    <img class="heroImg" src="g0.jpg" alt="A romantic background" />

    <div class="heroContent">
      <p class="smallTag">A little gift, made with love</p>

      <h1>Happy Valentine‚Äôs Day, <span class="name">JAAN ‚ù§Ô∏è</span></h1>

      <p class="heroText">
        ONLY YOU ‚Äî because you deserve something special,
        today and every day.
      </p>

      <div class="heroActions">
        <a class="btn primary" href="#letter">Open My Letter</a>
        <a class="btn ghost" href="#gallery">See Our Moments</a>
      </div>

      <div class="countdownCard">
        <div class="countTopRow">
          <div>
            <div class="countTitle">Our Love Timer</div>
            <p class="countHint">Since the day you became my favorite person.</p>
          </div>
        </div>

        <div class="countGrid">
          <div class="countBox"><div class="countNum" id="days">0</div><div class="countLbl">Days</div></div>
          <div class="countBox"><div class="countNum" id="hours">0</div><div class="countLbl">Hours</div></div>
          <div class="countBox"><div class="countNum" id="mins">0</div><div class="countLbl">Minutes</div></div>
          <div class="countBox"><div class="countNum" id="secs">0</div><div class="countLbl">Seconds</div></div>
        </div>

        <!-- Love meter -->
        <div class="meterWrap">
          <div class="meterTitle">
            Love Level:
            <span class="meterValue" id="meterValue">0%</span>
          </div>
          <div class="meterBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="meterFill" id="meterFill"></div>
          </div>
          <p class="meterHint">It grows every second‚Ä¶ because my love doesn‚Äôt stop.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Story -->
  <section class="section" id="story">
    <div class="container">
      <h2 class="sectionTitle">Our Story</h2>
      <p class="sectionSub">
        A few moments that I‚Äôll always keep close to my heart.
      </p>

      <div class="timeline">
        <div class="tItem">
          <div class="tDot"></div>
          <div class="tCard">
            <h3>When We First Met</h3>
            <p>
              I still remember the little details ‚Äî your smile, your vibe, the way you made
              everything feel easy.
            </p>
            <span class="tNote">‚ú¶ 2 May 2024, AIUB, Annex 5109</span>
          </div>
        </div>

        <div class="tItem">
          <div class="tDot"></div>
          <div class="tCard">
            <h3>My Favorite Memory</h3>
            <p>
              The day that made me think: ‚ÄúYes‚Ä¶ this is my person.‚Äù
              (You know which one.)
            </p>
            <span class="tNote">‚ú¶ 1st Semester, pre-registration day, when everyone is busy but you took me in your group.</span>
          </div>
        </div>

        <div class="tItem">
          <div class="tDot"></div>
          <div class="tCard">
            <h3>Today</h3>
            <p>
              I choose you ‚Äî again and again. I‚Äôm proud of you, I love you,
              and I‚Äôm grateful for you.
            </p>
            <span class="tNote">‚ú¶ You are everything to me. Just you.</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Reasons -->
  <section class="section soft" id="reasons">
    <div class="container">
      <h2 class="sectionTitle">Reasons I Love You</h2>
      <p class="sectionSub">I do not need any reason to love you‚Ä¶ but here‚Äôs a start.</p>

      <div class="grid3">
        <div class="card">
          <div class="icon">üíó</div>
          <h3>Your Kind Heart</h3>
          <p>You make people feel safe, loved, and seen ‚Äî including me. I feel peace around you.</p>
        </div>

        <div class="card">
          <div class="icon">‚ú®</div>
          <h3>Your Beautiful Energy</h3>
          <p>Everything feels brighter when you‚Äôre around. You cheer me up always.</p>
        </div>

        <div class="card">
          <div class="icon">üåπ</div>
          <h3>The Way You Love</h3>
          <p>Your love is the kind I always prayed for. I learn from you how you love.</p>
        </div>

        <div class="card">
          <div class="icon">ü•∞</div>
          <h3>Your Smile</h3>
          <p>One smile from you and my whole day changes. When I see your smile it hits different.</p>
        </div>

        <div class="card">
          <div class="icon">ü´∂</div>
          <h3>Your Support</h3>
          <p>You believe in me even when I‚Äôm doubting myself. I still remember the IP Lab exam.</p>
        </div>

        <div class="card">
          <div class="icon">üî•</div>
          <h3>Just‚Ä¶ You</h3>
          <p>You are my favorite place to be.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
      FEATURE #1: OPEN WHEN LETTERS
  ========================== -->
  <section class="section" id="openwhen">
    <div class="container">
      <h2 class="sectionTitle">Open When‚Ä¶</h2>
      <p class="sectionSub">Little letters for the exact moment you need them.</p>

      <div class="openWhenGrid" id="openWhenGrid">
        <!-- cards injected by JS -->
      </div>
    </div>

    <!-- Open When Modal -->
    <div class="owModal" id="owModal" aria-hidden="true">
      <div class="owBackdrop" data-close="true"></div>

      <div class="owPanel" role="dialog" aria-modal="true" aria-label="Open When letter">
        <button class="lbBtn owClose" id="owClose" type="button" aria-label="Close">‚úï</button>

        <div class="owTop">
          <div class="owEmoji" id="owEmoji">üíå</div>
          <div>
            <div class="owTitle" id="owTitle">Open when...</div>
            <div class="owSub" id="owSub">A little note for you</div>
          </div>
        </div>

        <div class="owBody">
          <p id="owText"></p>
        </div>

        <div class="owActions">
          <button class="btn primary" id="owConfetti" type="button">Hug me  ‚ú®</button>
          <button class="btn ghost" id="owRandom" type="button">Open another üíå</button>
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
      FEATURE #2: DISTANCE SECTION
  ========================== -->
  <section class="section soft" id="distance">
    <div class="container">
      <h2 class="sectionTitle">Distance Between Us</h2>
      <p class="sectionSub">Even if we‚Äôre far, you‚Äôre still my closest feeling.</p>

      <div class="distanceWrap">
        <div class="distanceCard">
          <div class="distanceRow">
            <div class="distanceLabel">From</div>
            <div class="distanceValue" id="fromPlace">My Place</div>
          </div>
          <div class="distanceRow">
            <div class="distanceLabel">To</div>
            <div class="distanceValue" id="toPlace">Your Place</div>
          </div>

          <div class="distanceBig">
            <div class="distanceNum" id="distanceKm">0</div>
            <div class="distanceUnit">KM</div>
          </div>

          <p class="distanceHint" id="distanceHint">
            But my heart travels faster than distance ‚ù§Ô∏è
          </p>

          <div class="distanceBtns">
            <button class="btn primary" id="recalcDistance" type="button">Recalculate üìç</button>
            <a class="btn ghost" id="openMapLink" href="#" target="_blank" rel="noreferrer">Open Map</a>
          </div>

          <p class="distanceSmall">
            Hati Hati Papa korte korte chole aso.
          </p>
        </div>

        <div class="mapCard">
          <div class="mapHead">
            <h3>Our Map</h3>
            <p>Just a cute view. (Open full map if you want.)</p>
          </div>
          <iframe
            id="osmMap"
            class="mapFrame"
            loading="lazy"
            referrerpolicy="no-referrer"
            title="OpenStreetMap embed"
          ></iframe>
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
      FEATURE #4: MOOD BUTTONS
  ========================== -->
  <section class="section" id="mood">
    <div class="container">
      <h2 class="sectionTitle">How are you feeling today?</h2>
      <p class="sectionSub">Pick one‚Ä¶ and I‚Äôll reply in my way. üíó</p>

      <div class="moodWrap">
        <div class="moodBtns">
          <button class="moodBtn" data-mood="happy" type="button">üòä Happy</button>
          <button class="moodBtn" data-mood="sad" type="button">üòî Sad</button>
          <button class="moodBtn" data-mood="angry" type="button">üò° Angry</button>
          <button class="moodBtn" data-mood="tired" type="button">üò¥ Tired</button>
          <button class="moodBtn" data-mood="love" type="button">ü•∞ In Love</button>
          <button class="moodBtn reset" data-mood="reset" type="button">Reset ‚ú®</button>
        </div>

        <div class="moodCard">
          <div class="moodTitle">My message for you</div>
          <p class="moodText" id="moodText">
            Choose a mood and I‚Äôll make the vibe match you.
          </p>
          <div class="moodTip">Yo....YOU....YOU...ONLY....you...</div>
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
      Slideshow
  ========================== -->
  <section class="section" id="slideshow">
    <div class="container">
      <h2 class="sectionTitle">Memory Slideshow</h2>
      <p class="sectionSub">A little film of us‚Ä¶ on repeat in my heart.</p>

      <div class="slider" aria-label="Memory slideshow">
        <div class="sliderFrame">
          <img id="slideImg" class="slideImg" src="g1.JPG" alt="Slideshow image">
          <div class="slideCap" id="slideCap">My favorite smile</div>
        </div>

        <div class="sliderControls">
          <button class="btn ghost" id="slidePrev" type="button">‚Äπ Prev</button>
          <button class="btn primary" id="slidePlay" type="button">‚è∏ Pause</button>
          <button class="btn ghost" id="slideNext" type="button">Next ‚Ä∫</button>
        </div>

        <div class="sliderDots" id="sliderDots" aria-label="Slideshow dots"></div>
      </div>
    </div>
  </section>

  <!-- Gallery + Lightbox -->
  <section class="section" id="gallery">
    <div class="container">
      <h2 class="sectionTitle">Our Moments</h2>

      <div class="gallery">
        <figure class="gItem">
          <img src="g1.JPG" alt="Moment 1" data-full="g1.JPG" loading="lazy" decoding="async">
          <figcaption>My favorite smile</figcaption>
        </figure>

        <figure class="gItem">
          <img src="g2.JPG" alt="Moment 2" data-full="g2.JPG" loading="lazy" decoding="async">
          <figcaption>From This</figcaption>
        </figure>

        <figure class="gItem">
          <img src="g3.jpeg" alt="Moment 3" data-full="g3.jpeg" loading="lazy" decoding="async">
          <figcaption>To This</figcaption>
        </figure>

        <figure class="gItem">
          <img src="g7.jpeg" alt="Moment 4" data-full="g7.jpeg" loading="lazy" decoding="async">
          <figcaption>My calm & my chaos</figcaption>
        </figure>

        <figure class="gItem">
          <img src="g5.JPG" alt="Moment 5" data-full="g5.JPG" loading="lazy" decoding="async">
          <figcaption>Softest memories</figcaption>
        </figure>

        <figure class="gItem">
          <img src="g6.JPG" alt="Moment 6" data-full="g6.JPG" loading="lazy" decoding="async">
          <figcaption>My favorite chapter</figcaption>
        </figure>
      </div>

      <div class="polaroidWrap">
        <div class="polaroid">
          <img src="g4.png" alt="Polaroid" loading="lazy" decoding="async" />
          <div class="polaroidText">Always you ‚ù§Ô∏è</div>
        </div>

        <div class="polaroidNote">
          <h3>One promise</h3>
          <p>
            I‚Äôll keep choosing you ‚Äî in the small moments, the hard moments,
            and the happiest moments.
          </p>
          <p class="signature">‚Äî Nafis</p>
        </div>
      </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox" aria-hidden="true">
      <div class="lightboxBackdrop" data-close="true"></div>

      <div class="lightboxPanel" role="dialog" aria-modal="true" aria-label="Image viewer">
        <button class="lbBtn lbClose" id="lbClose" type="button" aria-label="Close">‚úï</button>
        <button class="lbBtn lbPrev" id="lbPrev" type="button" aria-label="Previous">‚Äπ</button>

        <img class="lightboxImg" id="lightboxImg" alt="Full image" />

        <button class="lbBtn lbNext" id="lbNext" type="button" aria-label="Next">‚Ä∫</button>
      </div>
    </div>
  </section>

  <!-- Letter -->
  <section class="section soft" id="letter">
    <div class="container">
      <h2 class="sectionTitle">A Letter For You</h2>
      <p class="sectionSub">This part is my heart in words.</p>

      <div class="letterCard">
        <p>My love,</p>

        <p>
          Happy Valentine‚Äôs Day. I just want you to know that you are the best thing
          that has ever happened to me. Your presence feels like peace, your voice
          feels like home, and your love feels like a blessing.
        </p>

        <p>
          Thank you for being you ‚Äî for your patience, your kindness, your cute
          moments, and even the little things you don‚Äôt notice about yourself.
          I notice. I appreciate. I love.
        </p>

        <p>
          I can‚Äôt promise a perfect life, but I can promise a real love ‚Äî
          one that stays, one that listens, one that tries.
        </p>

        <p class="letterEnd">
          Forever yours,<br>
          <span class="hand">Nafis</span>
        </p>

        <button class="btn primary" id="surpriseBtn" type="button">Tap for a Surprise üíù</button>
        <p class="surprise" id="surpriseText" aria-live="polite"></p>
      </div>

      <div class="miniRow">
        <div class="miniCard">
          <h3>In My Opinion üéß</h3>
          <p>This only belongs to you.</p>
          <code class="codeLine">Click Here-></code>
          <a class="btn ghost"
             href="https://www.youtube.com/watch?v=cNGjD0VG4R8&list=RDcNGjD0VG4R8&start_radio=1"
             target="_blank" rel="noreferrer">
            Made for you
          </a>
        </div>

        <div class="miniCard">
          <h3>A Little date plan üïØÔ∏è</h3>
          <ul class="checkList">
            <li>Flowers + a handwritten note</li>
            <li>Your favorite snack</li>
            <li>1 hour walk / tea / coffee with you</li>
            <li>Endless memories ‚ù§Ô∏è</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Diary -->
  <section class="section" id="diary">
    <div class="container">
      <h2 class="sectionTitle">Our Diary</h2>
      <p class="sectionSub">Let's write down our memories together.</p>

      <div class="diaryWrap">
        <div class="diaryCard">
          <label class="diaryLabel" for="diaryText">Today‚Äôs Note</label>
          <textarea id="diaryText" class="diaryText" placeholder="Write today's memory... ‚ù§Ô∏è" rows="6"></textarea>

          <div class="diaryActions">
            <button class="btn primary" id="saveDiaryBtn" type="button">Save Note ‚úçÔ∏è</button>
            <button class="btn ghost" id="refreshDiaryBtn" type="button">Refresh</button>
          </div>

          <p class="diaryHint" id="diaryHint" aria-live="polite"></p>
        </div>

        <div class="diaryListCard">
          <div class="diaryListHeader">
            <h3 class="diaryListTitle">All Notes</h3>
          </div>
          <div class="diaryList" id="diaryList"></div>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <p>Made with ‚ù§Ô∏è just for you.</p>
  </footer>

  <!-- Background music -->
  <audio id="bgMusic" loop>
    <source src="music.mp3" type="audio/mpeg" />
  </audio>

  <script>
    // =========================
    // 0) SETTINGS
    // =========================
    const SECRET_CODE = "1501";

    // Diary API URL
    const DIARY_API_URL = "https://script.google.com/macros/s/AKfycbzC2tBjAXEMNxbcaMfA1xEBOxNcKT6ALmp0B0SqFVFLLbWGCpR1VP9vS0O1M9XUSAgy1g/exec";

    // Love start
    const loveStart = new Date("2025-01-13T18:11:59Z");

    // FEATURE #2: Distance settings (EDIT THESE)
    // Put your own coordinates + place names here
    const DIST_FROM = { name: "Banasree", lat: 23.754502, lon: 90.441620 };
    const DIST_TO   = { name: "Solmid", lat: 23.80129, lon: 90.42949 };

    // =========================
    // 1) PASSWORD LOCK
    // =========================
    const lockOverlay = document.getElementById("lockOverlay");
    const lockForm = document.getElementById("lockForm");
    const lockInput = document.getElementById("lockInput");
    const lockHint = document.getElementById("lockHint");

    function unlock(){
      lockOverlay.classList.add("hide");
      lockOverlay.setAttribute("aria-hidden", "true");
      document.body.classList.remove("locked");
      showToast("Welcome, my love ‚ù§Ô∏è");
    }
    document.body.classList.add("locked");

    lockForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const v = (lockInput.value || "").trim();
      if (!v){
        lockHint.textContent = "Type something ü•∫";
        return;
      }
      if (v.toLowerCase() === SECRET_CODE.toLowerCase()){
        lockHint.textContent = "Welcome, my love ‚ù§Ô∏è";
        setTimeout(unlock, 450);
      } else {
        lockHint.textContent = "Wrong secret üò∂ Try again";
        lockInput.value = "";
        lockInput.focus();
      }
    });

    // =========================
    // 2) TOAST
    // =========================
    const toast = document.getElementById("toast");
    let toastTimer = null;

    function showToast(text){
      toast.textContent = text;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove("show"), 2400);
    }

    // =========================
    // 3) LOVE TIMER
    // =========================
    function updateCounter() {
      const now = new Date();
      let diff = Math.max(0, now - loveStart);

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      diff -= days * (1000 * 60 * 60 * 24);

      const hours = Math.floor(diff / (1000 * 60 * 60));
      diff -= hours * (1000 * 60 * 60);

      const mins = Math.floor(diff / (1000 * 60));
      diff -= mins * (1000 * 60);

      const secs = Math.floor(diff / 1000);

      document.getElementById("days").textContent = days;
      document.getElementById("hours").textContent = hours;
      document.getElementById("mins").textContent = mins;
      document.getElementById("secs").textContent = secs;
    }
    updateCounter();
    setInterval(updateCounter, 1000);

    // =========================
    // 4) LOVE METER
    // =========================
    const meterFill = document.getElementById("meterFill");
    const meterValue = document.getElementById("meterValue");
    const meterBar = document.querySelector(".meterBar");

    let meter = 0;
    function animateMeterTo(target){
      const start = meter;
      const duration = 800;
      const t0 = performance.now();

      function frame(t){
        const p = Math.min(1, (t - t0) / duration);
        meter = Math.round(start + (target - start) * p);
        const shown = Math.min(100, meter);
        meterFill.style.width = shown + "%";
        meterValue.textContent = meter.toLocaleString() + "%";
        meterBar?.setAttribute("aria-valuenow", String(shown));
        if (p < 1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    animateMeterTo(100);

    setInterval(() => {
      meter += Math.floor(1 + Math.random() * 5);
      meterValue.textContent = meter.toLocaleString() + "%";
    }, 1000);

    // =========================
    // 5) SURPRISE + CONFETTI
    // =========================
    const surpriseBtn = document.getElementById("surpriseBtn");
    const surpriseText = document.getElementById("surpriseText");
    const surprises = [
      "You are my favorite person. Always. ‚ù§Ô∏è",
      "If I had to choose again, I‚Äôd still choose you. üíç",
      "You + me = my happiest place. ü•∞",
      "I‚Äôm proud of you. I‚Äôm grateful for you. I love you. üåπ",
      "One day I‚Äôll show you this website and say: ‚ÄòI made it because you‚Äôre my home.‚Äô ü´∂"
    ];

    surpriseBtn.addEventListener("click", () => {
      const msg = surprises[Math.floor(Math.random() * surprises.length)];
      surpriseText.textContent = msg;
      surpriseText.classList.add("show");
      fireConfetti();
    });

    // =========================
    // 6) MUSIC TOGGLE
    // =========================
    const musicBtn = document.getElementById("musicBtn");
    const bgMusic = document.getElementById("bgMusic");
    let musicOn = false;

    musicBtn.addEventListener("click", async () => {
      try {
        if (!musicOn) {
          await bgMusic.play();
          musicOn = true;
          musicBtn.textContent = "‚ùö‚ùö";
          musicBtn.classList.add("on");
        } else {
          bgMusic.pause();
          musicOn = false;
          musicBtn.textContent = "‚ô´";
          musicBtn.classList.remove("on");
        }
      } catch (e) {
        alert("To enable music, add music.mp3 in the same folder as index.html");
      }
    });

    // =========================
    // 7) THEME TOGGLE
    // =========================
    const themeBtn = document.getElementById("themeBtn");
    const root = document.documentElement;

    function setTheme(t){
      root.setAttribute("data-theme", t);
      themeBtn.textContent = (t === "dark") ? "üåô" : "‚òÄÔ∏è";
      localStorage.setItem("theme", t);
    }

    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "light" || savedTheme === "dark") setTheme(savedTheme);

    themeBtn.addEventListener("click", () => {
      const current = root.getAttribute("data-theme") || "dark";
      setTheme(current === "dark" ? "light" : "dark");
    });

    // =========================
    // 8) FLOATING LOVE NOTE
    // =========================
    const floatLove = document.getElementById("floatLove");
    const loveNotes = [
      "I miss you. Always. ü•∫‚ù§Ô∏è",
      "If you‚Äôre reading this, smile for me üòò",
      "You‚Äôre the best part of my day üåô",
      "Come here‚Ä¶ virtual hug ü§ç",
      "One day: us, coffee, sunset, quiet love ‚òïüåÖ",
      "I‚Äôm proud of you. Don‚Äôt forget that ü´∂"
    ];
    floatLove.addEventListener("click", () => {
      showToast(loveNotes[Math.floor(Math.random() * loveNotes.length)]);
    });

    // =========================
    // FEATURE #3: CURSOR HEARTS
    // =========================
    const cursorHearts = document.getElementById("cursorHearts");
    let lastHeartTime = 0;

    function spawnHeart(x, y){
      const now = Date.now();
      if (now - lastHeartTime < 25) return; // limit
      lastHeartTime = now;

      const el = document.createElement("span");
      el.className = "cHeart";
      el.textContent = Math.random() < 0.25 ? "üíó" : "‚ù§";
      el.style.left = x + "px";
      el.style.top = y + "px";
      el.style.fontSize = (12 + Math.random() * 10) + "px";
      el.style.transform = `translate(-50%, -50%) rotate(${(-18 + Math.random()*36).toFixed(1)}deg)`;
      cursorHearts.appendChild(el);

      setTimeout(() => el.remove(), 900);
    }

    document.addEventListener("mousemove", (e) => {
      if (document.body.classList.contains("locked")) return;
      spawnHeart(e.clientX, e.clientY);
    });

    document.addEventListener("touchstart", (e) => {
      if (document.body.classList.contains("locked")) return;
      const t = e.touches?.[0];
      if (!t) return;
      spawnHeart(t.clientX, t.clientY);
    }, { passive: true });

    // =========================
    // FEATURE #1: OPEN WHEN
    // =========================
    const owList = [
      {
        title: "Open when you feel sad",
        emoji: "ü•∫",
        sub: "I‚Äôm here. Always.",
        text:
          "Hey love‚Ä¶ breathe. You don‚Äôt have to be strong all the time. " +
          "I‚Äôm proud of you for surviving days nobody saw. " +
          "Drink water, rest your head, and remember: you‚Äôre loved deeply."
      },
      {
        title: "Open when you miss me",
        emoji: "ü´∂",
        sub: "Come closer (virtually).",
        text:
          "I miss you too. If I could, I‚Äôd pull you into the longest hug. " +
          "Until then‚Ä¶ read this and feel me near you. " +
          "You‚Äôre my favorite thought."
      },
      {
        title: "Open when you doubt yourself",
        emoji: "‚ú®",
        sub: "You‚Äôre more than enough.",
        text:
          "You are capable. You are smart. You are stronger than you think. " +
          "Even if you don‚Äôt see it today, I see it clearly. " +
          "Keep going. I‚Äôm cheering for you."
      },
      {
        title: "Open when you‚Äôre happy",
        emoji: "üòç",
        sub: "I want to celebrate you!",
        text:
          "I LOVE seeing you happy. Your smile is my favorite view. " +
          "Keep that joy safe‚Äî and save some for me too üòå‚ù§Ô∏è"
      },
      {
        title: "Open when you‚Äôre tired",
        emoji: "üò¥",
        sub: "Rest. I‚Äôll hold the world for a bit.",
        text:
          "You did enough today. Even small progress is progress. " +
          "Close your eyes, relax your shoulders, and let yourself rest. " +
          "I‚Äôm proud of you."
      },
      {
        title: "Open when you need motivation",
        emoji: "üî•",
        sub: "One more step. That‚Äôs all.",
        text:
          "You don‚Äôt have to do everything at once. Just one step. " +
          "Start small, keep moving, and watch yourself win. " +
          "I believe in you."
      }
    ];

    const openWhenGrid = document.getElementById("openWhenGrid");
    openWhenGrid.innerHTML = owList.map((o, i) => `
      <button class="owCard" type="button" data-idx="${i}">
        <div class="owCardEmoji">${o.emoji}</div>
        <div class="owCardTitle">${o.title}</div>
        <div class="owCardSub">${o.sub}</div>
        <div class="owCardHint">Tap to open üíå</div>
      </button>
    `).join("");

    const owModal = document.getElementById("owModal");
    const owClose = document.getElementById("owClose");
    const owEmoji = document.getElementById("owEmoji");
    const owTitle = document.getElementById("owTitle");
    const owSub = document.getElementById("owSub");
    const owText = document.getElementById("owText");
    const owConfetti = document.getElementById("owConfetti");
    const owRandom = document.getElementById("owRandom");

    let owIndex = 0;

    function openOW(idx){
      owIndex = idx;
      const o = owList[owIndex];
      owEmoji.textContent = o.emoji;
      owTitle.textContent = o.title;
      owSub.textContent = o.sub;
      owText.textContent = o.text;

      owModal.classList.add("open");
      owModal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeOW(){
      owModal.classList.remove("open");
      owModal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    openWhenGrid.querySelectorAll(".owCard").forEach(btn => {
      btn.addEventListener("click", () => openOW(Number(btn.dataset.idx)));
    });

    owClose.addEventListener("click", closeOW);
    owModal.addEventListener("click", (e) => {
      if (e.target.dataset.close === "true") closeOW();
    });
    document.addEventListener("keydown", (e) => {
      if (!owModal.classList.contains("open")) return;
      if (e.key === "Escape") closeOW();
    });

    owConfetti.addEventListener("click", () => {
      fireConfetti(true);
      showToast("Sending you a warm hug ‚ù§Ô∏è");
    });

    owRandom.addEventListener("click", () => {
      const next = Math.floor(Math.random() * owList.length);
      openOW(next);
    });

    // =========================
    // FEATURE #2: DISTANCE (Haversine)
    // =========================
    const fromPlace = document.getElementById("fromPlace");
    const toPlace = document.getElementById("toPlace");
    const distanceKmEl = document.getElementById("distanceKm");
    const distanceHint = document.getElementById("distanceHint");
    const recalcBtn = document.getElementById("recalcDistance");
    const openMapLink = document.getElementById("openMapLink");
    const osmMap = document.getElementById("osmMap");

    function toRad(deg){ return deg * Math.PI / 180; }

    function haversineKm(a, b){
      const R = 6371;
      const dLat = toRad(b.lat - a.lat);
      const dLon = toRad(b.lon - a.lon);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);

      const s = Math.sin(dLat/2)**2 +
                Math.sin(dLon/2)**2 * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
      return R * c;
    }

    function buildOsmEmbed(a, b){
      // midpoint + bbox
      const midLat = (a.lat + b.lat) / 2;
      const midLon = (a.lon + b.lon) / 2;

      const pad = 0.35; // adjust view size
      const minLat = Math.min(a.lat, b.lat) - pad;
      const maxLat = Math.max(a.lat, b.lat) + pad;
      const minLon = Math.min(a.lon, b.lon) - pad;
      const maxLon = Math.max(a.lon, b.lon) + pad;

      const src =
        "https://www.openstreetmap.org/export/embed.html" +
        `?bbox=${encodeURIComponent(minLon)},${encodeURIComponent(minLat)},${encodeURIComponent(maxLon)},${encodeURIComponent(maxLat)}` +
        `&layer=mapnik&marker=${encodeURIComponent(midLat)},${encodeURIComponent(midLon)}`;

      return src;
    }

    function buildOsmLink(a, b){
      const midLat = (a.lat + b.lat) / 2;
      const midLon = (a.lon + b.lon) / 2;
      return `https://www.openstreetmap.org/?mlat=${midLat}&mlon=${midLon}#map=7/${midLat}/${midLon}`;
    }

    function renderDistance(){
      fromPlace.textContent = DIST_FROM.name;
      toPlace.textContent = DIST_TO.name;

      const km = haversineKm(DIST_FROM, DIST_TO);
      distanceKmEl.textContent = km.toFixed(1);

      if (km < 5) distanceHint.textContent = "So close‚Ä¶ I can almost hold your hand ‚ù§Ô∏è";
      else if (km < 50) distanceHint.textContent = "Not far‚Ä¶ just one hug away ü´∂";
      else if (km < 300) distanceHint.textContent = "Distance is real, but love is stronger üíó";
      else distanceHint.textContent = "Far‚Ä¶ but you‚Äôre still my closest feeling ‚ù§Ô∏è";

      openMapLink.href = buildOsmLink(DIST_FROM, DIST_TO);
      osmMap.src = buildOsmEmbed(DIST_FROM, DIST_TO);
    }
    renderDistance();
    recalcBtn.addEventListener("click", () => {
      renderDistance();
      showToast("Distance updated üìç");
      fireConfetti();
    });

    // =========================
    // FEATURE #4: MOOD SYSTEM
    // =========================
    const moodText = document.getElementById("moodText");
    const moodBtns = Array.from(document.querySelectorAll(".moodBtn"));

    const moodMessages = {
      happy: "Your happiness is my favorite sound. Keep smiling‚Ä¶ I‚Äôm smiling too üòä‚ù§Ô∏è",
      sad: "Come here‚Ä¶ breathe. You‚Äôre not alone, not even for a second ü•∫ü´∂",
      angry: "It‚Äôs okay to feel it. I‚Äôm on your side. Let‚Äôs calm down together üò§‚û°Ô∏èüòå",
      tired: "Rest, love. You did enough today. I‚Äôm proud of you üò¥‚ù§Ô∏è",
      love: "You‚Äôre in love? Same. Always. Forever. ü•∞üíç",
      reset: "Choose a mood and I‚Äôll match the vibe for you üíó"
    };

    function setMood(mood){
      if (mood === "reset"){
        document.body.removeAttribute("data-mood");
        moodText.textContent = moodMessages.reset;
        showToast("Mood reset ‚ú®");
        return;
      }
      document.body.setAttribute("data-mood", mood);
      moodText.textContent = moodMessages[mood] || moodMessages.reset;
      showToast("Mood set: " + mood + " üíû");
    }

    moodBtns.forEach(b => b.addEventListener("click", () => setMood(b.dataset.mood)));

    // =========================
    // 9) SLIDESHOW
    // =========================
    const slides = [
      { src: "g1.JPG", cap: "My favorite smile" },
      { src: "g2.JPG", cap: "From this..." },
      { src: "g3.jpeg", cap: "To this..." },
      { src: "g7.jpeg", cap: "My calm & my chaos" },
      { src: "g5.JPG", cap: "Softest memories" },
      { src: "g6.JPG", cap: "My favorite chapter" }
    ];

    const slideImg = document.getElementById("slideImg");
    const slideCap = document.getElementById("slideCap");
    const slidePrev = document.getElementById("slidePrev");
    const slideNext = document.getElementById("slideNext");
    const slidePlay = document.getElementById("slidePlay");
    const sliderDots = document.getElementById("sliderDots");

    let slideIndex = 0;
    let slidePlaying = true;
    let slideTimer = null;

    function renderDots(){
      sliderDots.innerHTML = slides.map((_, i) =>
        `<button class="dot ${i===slideIndex?"on":""}" type="button" aria-label="Go to slide ${i+1}"></button>`
      ).join("");

      Array.from(sliderDots.querySelectorAll(".dot")).forEach((b, i) => {
        b.addEventListener("click", () => {
          slideIndex = i;
          renderSlide();
          restartSlideTimer();
        });
      });
    }

    function renderSlide(){
      const s = slides[slideIndex];
      slideImg.classList.remove("in");
      setTimeout(() => {
        slideImg.src = s.src;
        slideCap.textContent = s.cap;
        slideImg.classList.add("in");
        renderDots();
      }, 120);
    }

    function nextSlide(){
      slideIndex = (slideIndex + 1) % slides.length;
      renderSlide();
    }
    function prevSlide(){
      slideIndex = (slideIndex - 1 + slides.length) % slides.length;
      renderSlide();
    }

    function restartSlideTimer(){
      if (slideTimer) clearInterval(slideTimer);
      if (!slidePlaying) return;
      slideTimer = setInterval(nextSlide, 3500);
    }

    slidePrev.addEventListener("click", () => { prevSlide(); restartSlideTimer(); });
    slideNext.addEventListener("click", () => { nextSlide(); restartSlideTimer(); });

    slidePlay.addEventListener("click", () => {
      slidePlaying = !slidePlaying;
      slidePlay.textContent = slidePlaying ? "‚è∏ Pause" : "‚ñ∂ Play";
      restartSlideTimer();
    });

    renderSlide();
    restartSlideTimer();

    // =========================
    // 10) LIGHTBOX
    // =========================
    const galleryImgs = Array.from(document.querySelectorAll(".gallery img"));
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightboxImg");
    const lbClose = document.getElementById("lbClose");
    const lbPrev = document.getElementById("lbPrev");
    const lbNext = document.getElementById("lbNext");

    let currentIndex = 0;

    function openLightbox(index){
      currentIndex = index;
      const fullSrc = galleryImgs[currentIndex].dataset.full || galleryImgs[currentIndex].src;
      lightboxImg.src = fullSrc;
      lightbox.classList.add("open");
      lightbox.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeLightbox(){
      lightbox.classList.remove("open");
      lightbox.setAttribute("aria-hidden", "true");
      lightboxImg.src = "";
      document.body.style.overflow = "";
    }

    function showPrev(){
      currentIndex = (currentIndex - 1 + galleryImgs.length) % galleryImgs.length;
      openLightbox(currentIndex);
    }

    function showNext(){
      currentIndex = (currentIndex + 1) % galleryImgs.length;
      openLightbox(currentIndex);
    }

    galleryImgs.forEach((img, i) => {
      img.style.cursor = "zoom-in";
      img.addEventListener("click", () => openLightbox(i));
    });

    lbClose.addEventListener("click", closeLightbox);
    lbPrev.addEventListener("click", showPrev);
    lbNext.addEventListener("click", showNext);

    lightbox.addEventListener("click", (e) => {
      if (e.target.dataset.close === "true") closeLightbox();
    });

    document.addEventListener("keydown", (e) => {
      if (!lightbox.classList.contains("open")) return;
      if (e.key === "Escape") closeLightbox();
      if (e.key === "ArrowLeft") showPrev();
      if (e.key === "ArrowRight") showNext();
    });

    // =========================
    // 11) DIARY API
    // =========================
    const diaryText = document.getElementById("diaryText");
    const saveDiaryBtn = document.getElementById("saveDiaryBtn");
    const refreshDiaryBtn = document.getElementById("refreshDiaryBtn");
    const diaryList = document.getElementById("diaryList");
    const diaryHint = document.getElementById("diaryHint");

    function setHint(msg){
      if (!diaryHint) return;
      diaryHint.textContent = msg || "";
    }

    function escapeHtmlSafe(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatDate(iso){
      const d = new Date(iso);
      return d.toLocaleString(undefined, {
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });
    }

    async function apiListNotes(){
      const res = await fetch(`${DIARY_API_URL}?action=list`, { method: "GET" });
      return res.json();
    }

    async function apiAddNote(text){
      const payload = { action: "add", text: text.trim() };
      const res = await fetch(DIARY_API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    async function apiDeleteNote(id){
      const payload = { action: "delete", id };
      const res = await fetch(DIARY_API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    async function renderDiary(){
      if (!diaryList) return;
      diaryList.innerHTML = `<div class="noteItem"><p class="noteText">Loading‚Ä¶</p></div>`;

      try{
        const data = await apiListNotes();
        if (!data.ok) throw new Error(data.error || "Failed");

        const notes = data.notes || [];
        if (notes.length === 0){
          diaryList.innerHTML = `<div class="noteItem"><p class="noteText">No notes yet. Write your first one ‚ù§Ô∏è</p></div>`;
          return;
        }

        diaryList.innerHTML = notes.map(n => `
          <div class="noteItem" data-id="${escapeHtmlSafe(n.id)}">
            <div class="noteTop">
              <div class="noteDate">${escapeHtmlSafe(formatDate(n.createdAt))}</div>
              <button class="noteDel" type="button" aria-label="Delete note">üóë</button>
            </div>
            <p class="noteText">${escapeHtmlSafe(n.text).replaceAll("\n","<br>")}</p>
          </div>
        `).join("");

        diaryList.querySelectorAll(".noteItem").forEach(item => {
          const id = item.getAttribute("data-id");
          const delBtn = item.querySelector(".noteDel");
          delBtn.addEventListener("click", async () => {
            try{
              setHint("Deleting‚Ä¶");
              const d = await apiDeleteNote(id);
              if (!d.ok) throw new Error(d.error || "Delete failed");
              setHint("Deleted ‚úÖ");
              await renderDiary();
            }catch(err){
              setHint("Delete failed ‚ùå");
            }
          });
        });

      }catch(err){
        diaryList.innerHTML = `<div class="noteItem"><p class="noteText">Failed to load notes. Check API URL / deployment access.</p></div>`;
        setHint("Could not load notes ‚ùå");
      }
    }

    saveDiaryBtn?.addEventListener("click", async () => {
      const text = diaryText.value.trim();
      if (!text){
        setHint("Write something first üòä");
        return;
      }
      try{
        setHint("Saving‚Ä¶");
        const data = await apiAddNote(text);
        if (!data.ok) throw new Error(data.error || "Save failed");
        diaryText.value = "";
        setHint("Saved ‚ù§Ô∏è");
        await renderDiary();
      }catch(err){
        setHint("Save failed ‚ùå");
      }
    });

    refreshDiaryBtn?.addEventListener("click", renderDiary);
    renderDiary();

    // =========================
    // 12) EASTER EGG: type "i love you"
    // =========================
    let typed = "";
    const targetPhrase = "i love you";
    document.addEventListener("keydown", (e) => {
      if (document.body.classList.contains("locked")) return;
      if (e.key.length === 1) {
        typed += e.key.toLowerCase();
        if (typed.length > 40) typed = typed.slice(-40);

        if (typed.includes(targetPhrase)) {
          typed = "";
          fireConfetti(true);
          showToast("AND I LOVE YOU MORE ‚ù§Ô∏è‚ú®");
          document.body.classList.add("pulseLove");
          setTimeout(() => document.body.classList.remove("pulseLove"), 1100);
        }
      }
    });

    // =========================
    // 13) CONFETTI (canvas)
    // =========================
    const canvas = document.getElementById("confettiCanvas");
    const ctx = canvas.getContext("2d");
    let confettiPieces = [];
    let confettiRunning = false;

    function resizeCanvas(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function makePiece(isHearts){
      const x = Math.random() * canvas.width;
      const y = -20 - Math.random() * 100;
      const size = 6 + Math.random() * 10;
      const speed = 2 + Math.random() * 4;
      const drift = -1 + Math.random() * 2;
      const rot = Math.random() * Math.PI * 2;
      const rotSpd = (-0.08 + Math.random() * 0.16);
      const shape = isHearts ? "heart" : (Math.random() < 0.3 ? "heart" : "rect");
      return { x, y, size, speed, drift, rot, rotSpd, shape, life: 0 };
    }

    function drawHeart(x, y, s, rot){
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rot);
      ctx.scale(s/18, s/18);
      ctx.beginPath();
      ctx.moveTo(0, 6);
      ctx.bezierCurveTo(0, 0, -10, 0, -10, 6);
      ctx.bezierCurveTo(-10, 12, 0, 16, 0, 22);
      ctx.bezierCurveTo(0, 16, 10, 12, 10, 6);
      ctx.bezierCurveTo(10, 0, 0, 0, 0, 6);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    function fireConfetti(heartsMode=false){
      resizeCanvas();
      confettiPieces = [];
      const count = heartsMode ? 120 : 90;
      for (let i=0; i<count; i++) confettiPieces.push(makePiece(heartsMode));
      if (!confettiRunning){
        confettiRunning = true;
        requestAnimationFrame(confettiLoop);
      }
    }

    function confettiLoop(){
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const colors = ["#ff4d8d", "#ff7aa6", "#ffd1e1", "#ffffff"];

      confettiPieces.forEach(p => {
        p.life += 1;
        p.y += p.speed;
        p.x += p.drift;
        p.rot += p.rotSpd;

        const c = colors[Math.floor(Math.random() * colors.length)];
        ctx.fillStyle = c;

        if (p.shape === "rect"){
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size * 0.6);
          ctx.restore();
        } else {
          drawHeart(p.x, p.y, p.size, p.rot);
        }
      });

      confettiPieces = confettiPieces.filter(p => p.y < canvas.height + 40 && p.life < 220);

      if (confettiPieces.length > 0){
        requestAnimationFrame(confettiLoop);
      } else {
        confettiRunning = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }
  </script>
</body>
</html>